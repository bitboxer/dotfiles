#!/bin/sh
# Based on link-dotfiles by Lucas Dohmen, MIT license
# https://github.com/moonglum/dotfiles/blob/main/tilde/exe/link-dotfiles

# link all provided files as dotfiles in ~
set -eu

# idempotent ln -s
ilns() {
	file_description=$(file -bh "$2")
  source="$(realpath "$1")"

	if [ "$file_description" = "symbolic link to $source" ]
	then
		echo "Already linked correctly: $2"
	else
	  if [ -e "$2" ]
	  then
	    echo "Moving existing file: $2"
	    mv "$2" "$2.bak"
	  fi
		ln -s "$source" "$2"
	fi
}

for file in "$@"
do
  file="$(readlink -e "$file")"
  item=$(basename "$file")
	
  [ "$item" !=  "config" ] && ilns "$file" "$HOME/.$(basename "$file")"
done

for file in "$@/config"
do
  file="$(readlink -e "$file")"
  ilns "$file" "$HOME/.config/$(basename "$file")"
done
